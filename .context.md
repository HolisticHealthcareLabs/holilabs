---
owner: Holi Labs Engineering
purpose: "Agent + team guardrails for safe, consistent changes"
scope: "Applies to all worktrees, all PRs"
last_updated: 2026-01-22
---

# Holi Labs Engineering Context (10/10)

This file is **instructions for AI coding agents and humans**. It is not runtime config.

## Non-negotiables (read first)
- **No secrets** in repo files, logs, screenshots, tests, or examples. Never paste API keys/tokens/certs.
- **No PHI/PII in logs**. Redact or omit. If unsure, treat as PHI.
- **Deny-by-default** authorization on the server. Never rely on client-side guards.
- **Validation required** on every boundary (API requests, webhooks, LLM outputs).
- **Backwards compatibility**: do not break production flows without a migration/rollout plan.

## Product principles (healthtech-grade)
- Optimize for **patient safety**, clinician trust, and auditability over “moving fast.”
- Prefer **explicit behavior** over “magic”: clear error messages, typed contracts, and predictable flows.
- Avoid silent failures; if something matters clinically, make failure modes obvious and observable.

## Data classification & handling
- **PHI/PII includes**: names, MRNs, DOB, dates tied to individuals, free-text notes, imaging, identifiers, message content.
- **Minimize**: fetch/store the smallest dataset needed; avoid duplicating PHI across systems.
- **Storage**: do not introduce new long-lived storage of raw clinical text, prompts, or model responses without:
  - retention policy,
  - access policy,
  - audit logging,
  - and a deletion story.
- **Exports**: exporting clinical data requires explicit user intent + audit log entry.

## Compliance posture (HIPAA / SOC2 mindset)
- **Audit trail**: any PHI access/change should be attributable (who/when/what/why/result).
- **Least privilege**: minimize scopes, roles, and DB access.
- **Vendor risk**: do not send PHI to any external system unless explicitly approved by configuration/policy.
- **Security reviews**: anything touching auth, session, middleware, encryption, file uploads, or AI egress needs careful review and tests.

## Authentication & Authorization (do not improvise)
- **Clinician auth**: use the repo’s NextAuth v5 pattern (typically `auth()`).
- **Patient auth**: use the repo’s patient session helper(s) (custom JWT/session). Do not mix identities.
- **Authorization** must happen **server-side** for every route/mutation:
  - check role/relationship/tenant,
  - enforce row-level constraints,
  - and return consistent `401`/`403` semantics.
- **Multi-tenant safety**: always scope reads/writes by tenant/organization when applicable.

## API standards (Next.js App Router / route handlers)
- **Request validation**: Zod on input; reject unexpected fields where appropriate.
- **Response stability**: prefer consistent error shapes:
  - `400` validation, `401` unauthenticated, `403` unauthorized, `404` not found, `409` conflict, `429` rate limited, `500` unexpected.
- **Rate limiting**: apply to public endpoints and any expensive operations (AI, search, exports).
- **Idempotency**: required for side-effect endpoints (payments, messaging sends, webhooks replays).
- **Streaming**: if streaming responses, ensure disconnect handling, timeouts, and structured events.

## AI / LLM governance (ship-safe)
- **Never trust model output**: all AI outputs must be validated (Zod) before use.
- **JSON bridge pattern**: require strict JSON, versioned schemas, and deterministic parsing.
- **Prompt injection**: treat user-provided text as untrusted; do not allow it to alter tools/policies.
- **Tool/action gating**: models do not get to perform privileged actions without a policy layer.
- **PHI egress**: do not send PHI to non-approved providers. If redaction is used:
  - log only redaction counts/types, never raw text.
- **Reproducibility**: store schema version + model + temperature/settings for clinically meaningful outputs (without storing PHI).

## Security engineering expectations
- **CSRF/XSS**: never render unsanitized HTML; use safe escaping; keep CSP strong.
- **Nonce/hydration**: avoid per-request randomness in SSR markup unless correctly synchronized.
- **File uploads**: validate type/size, virus scan if applicable, store with least privilege, signed URLs, and audit.
- **Crypto**: use vetted libs; no custom crypto. Keys never in code.

## Database (Prisma) & migrations
- Avoid N+1 queries; use `select/include` intentionally; prefer server-side pagination.
- Add indices for new query paths; document why in PR.
- Schema changes require:
  - migration,
  - backfill strategy (if needed),
  - and downgrade/rollback notes for production.
- For PHI tables/fields, PR must include:
  - access controls,
  - audit logging touchpoints,
  - and retention/deletion notes.

## Observability (debuggable by design)
- Use structured logs and include `requestId` and stable identifiers (non-PHI).
- Never log raw request bodies if they may contain PHI.
- Emit audit events separately from application logs.
- For new critical paths: add metrics/tracing (latency, error rate, external dependency timing).

## Frontend (Next.js)
- Never expose secrets to the client bundle.
- Avoid hydration mismatches (time/randomness/user-agent-dependent rendering).
- Patient-facing UX: prefer accessibility, clarity, and localization requirements (Spanish if product requires).

## PR / change management standards
- PRs must include:
  - **Summary** (why),
  - **Risk/rollback** (what could break, how to revert),
  - **Verification** checklist,
  - and screenshots/videos for UI changes.
- Any change impacting auth/session/middleware/AI egress requires explicit reviewer attention and tests.

## Agent execution rules (how to work here)
- Prefer small, reviewable commits.
- Do not refactor unrelated code in the same PR.
- When uncertain about an existing pattern, search the codebase and follow precedent.
- Add regression tests for bug fixes; add contract tests for API shape changes.
